{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="{% static 'deals/css/deals_styles.css' %}">

{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center mb-4">Deals Dashboard</h1>

    {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
    {% endif %}

    <form id="dateForm" method="get" class="mb-4">
        <div class="form-row align-items-center">
            <div class="col-md-3 mb-2">
                <label for="datepicker">Select Date</label>
                <input type="text" id="datepicker" name="date" value="{{ selected_date|date:'Y-m-d' }}" class="form-control" placeholder="Select date">
            </div>
            <div class="col-md-3 mb-2">
                <label for="viewType">View Type</label>
                <select name="view_type" id="viewType" class="form-control">
                    <option value="day" {% if view_type == 'day' %}selected{% endif %}>Day View</option>
                    <option value="month" {% if view_type == 'month' %}selected{% endif %}>Month View</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label for="carType">Car Type</label>
                <select name="car_type" id="carType" class="form-control">
                    <option value="ALL" {% if car_type == 'ALL' %}selected{% endif %}>All Cars</option>
                    <option value="NEW" {% if car_type == 'NEW' %}selected{% endif %}>New Cars</option>
                    <option value="USED" {% if car_type == 'USED' %}selected{% endif %}>Used Cars</option>
                </select>
            </div>
            <div class="col-md-3 mb-2 d-flex align-items-end">
                <button type="button" id="applyButton" class="btn btn-apply btn-block">Apply</button>
            </div>
        </div>
    </form>

    <div id="dealsContent">
        {% include "deals_content.html" %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const datepicker = flatpickr("#datepicker", {
            dateFormat: "Y-m-d",
            maxDate: "today"
        });

        document.getElementById("applyButton").addEventListener("click", updateDeals);

        function updateDeals() {
            const formData = new FormData(document.getElementById('dateForm'));
            const searchParams = new URLSearchParams(formData);

            fetch('{% url "deals_by_date" %}?' + searchParams.toString(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('dealsContent').innerHTML = html;
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>
{% endblock %}